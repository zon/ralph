name: argo-workflow-execution
description: Add Argo Workflow remote execution support

requirements:
  - category: configuration
    description: Workflow configuration options
    items:
      - Config supports workflow.image.repository for container image repository
      - Config supports workflow.image.tag for container image tag
      - Config supports workflow.configMaps list for mounting ConfigMaps
      - Config supports workflow.secrets list for mounting Secrets
      - Config supports workflow.env map for environment variables
      - Config supports workflow.context for Kubernetes context name
      - Config supports workflow.namespace for Kubernetes namespace
    passing: true

  - category: cli
    description: Remote execution command-line interface
    items:
      - Ralph accepts --remote flag to enable workflow execution
      - Ralph accepts --watch flag to monitor workflow execution
      - Watch flag is only applicable with --remote flag
      - Remote mode is incompatible with --once flag
      - Remote mode without --watch disables notifications
      - Help text documents remote execution and watch options
    passing: true

  - category: config-git
    description: Git credentials configuration
    items:
      - Ralph config git command generates SSH key pair
      - Command creates/updates git credentials Secret with private key
      - Command outputs public key to user
      - Command outputs link to GitHub SSH key settings page
      - Command applies to configured Kubernetes context and namespace
      - Command provides helpful feedback on success and errors
    passing: true

  - category: config-github
    description: GitHub credentials configuration
    items:
      - Ralph config github command prompts for GitHub personal access token
      - Command outputs link to GitHub token creation page
      - Command creates/updates GitHub token Secret
      - GitHub token stored in Kubernetes Secret
      - Command applies to configured Kubernetes context and namespace
      - Command provides helpful feedback on success and errors
    passing: true

  - category: config-opencode
    description: OpenCode credentials configuration
    items:
      - Ralph config opencode command reads ~/.local/share/opencode/auth.json
      - Command creates/updates OpenCode credentials Secret from auth.json
      - OpenCode credentials include all configured providers and tokens
      - Command applies to configured Kubernetes context and namespace
      - Command provides helpful feedback on success and errors
    passing: true

  - category: workflow-generation
    description: Argo Workflow YAML generation
    items:
      - Workflow uses generateName with project name as prefix for automatic suffix
      - Workflow YAML includes project file embedded as workflow parameter
      - Workflow includes .ralph/config.yaml as workflow parameter if it exists
      - Workflow includes .ralph/instructions.md as workflow parameter if it exists
      - Workflow includes git credentials Secret for cloning
      - Workflow includes github credentials Secret for PR creation
      - Workflow includes OpenCode auth.json Secret for AI operations
      - Workflow mounts auth.json to ~/.local/share/opencode/auth.json
      - Workflow includes user-specified configMaps from config
      - Workflow includes user-specified secrets from config
      - Workflow clones git repository to volatile filesystem
      - Workflow checks out the current branch
      - Workflow writes parameter files to disk before running ralph
      - Workflow runs ralph with the embedded project file
      - Workflow creates branch and PR just like normal execution
      - Workflow uses configured image, configMaps, secrets, and env vars
      - Workflow applies to configured Kubernetes context and namespace
    passing: false

  - category: execution
    description: Workflow submission and monitoring
    items:
      - Ralph generates complete Argo Workflow YAML
      - Workflow is submitted using argo submit command
      - Argo CLI is required for remote execution
      - When --watch flag is used, argo submit --watch monitors execution
      - User receives workflow name and monitoring information
      - Errors during workflow submission are reported clearly
    passing: false

  - category: workflow-lifecycle
    description: Workflow cleanup and resource management
    items:
      - Workflows configured with TTL to auto-delete after 1 day
      - Workflows configured to delete pods after completion
      - Workflows use volatile filesystem for git repository
      - No persistent volume claims are created
      - Completed workflows are automatically cleaned up by Argo
    passing: false

  - category: default-image
    description: Default container image creation
    items:
      - Dockerfile builds image with ralph and dependencies installed
      - Image includes go toolchain
      - Image includes bun runtime
      - Image includes playwright with browser dependencies
      - Script at ./scripts/push-default-image.sh builds and pushes image
      - Script uses configured repository and tag from variables
      - Image is published and tagged for use in workflows
    passing: false

  - category: documentation
    description: Usage documentation
    items:
      - Documentation explains remote execution workflow
      - Config.yaml format for workflow settings is documented
      - Default image location and contents are documented
      - Users can override with custom image via config
    passing: false
