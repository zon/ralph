name: github-webhook-service
description: GitHub webhook service that responds to PR comments by running ralph workflows

requirements:
  - category: webhook-server
    description: HTTP server using Gin that receives and validates GitHub webhook events
    items:
      - Service is written in Go using the Gin framework
      - Service listens for incoming HTTP requests on a configurable port
      - Requests are authenticated using GitHub webhook secret signature (HMAC-SHA256 of request body)
      - Requests with invalid or missing signatures are rejected with 401
      - Service handles pull_request_review_comment and pull_request_review events
      - Service handles pull_request_review events where the review state is "approved"
      - Service ignores issue_comment events entirely
      - Unrecognized event types are ignored gracefully with 200
    passing: true

  - category: event-filtering
    description: Only process events on PRs opened by ralph, not posted by ralph
    items:
      - All events are filtered to only process PRs opened by ralph (configurable ralph username)
      - All events posted by ralph are ignored
      - Events that fail these checks are acknowledged with 200 but not processed
    passing: true

  - category: configuration
    description: Config and secrets loaded from separate YAML files
    items:
      - App config is loaded from a config YAML file (port, ralph username, repos list, model)
      - Secrets are loaded from a separate secrets YAML file (GitHub token, per-repo webhook secrets)
      - Each repo entry in config has owner, name, and local clone path
      - Each repo entry in secrets has its webhook secret for request validation
      - Config and secrets file paths are specified via environment variables or CLI flags
      - Service fails to start with a clear error if required secrets are missing
    passing: true

  - category: ralph-cli-instructions-flag
    description: Ralph CLI accepts an --instructions flag to override agent instructions
    items:
      - Ralph run command accepts an --instructions flag that takes a file path
      - When --instructions is provided, its contents replace the default instructions section of the prompt
      - The instructions file content is injected in place of the default .ralph/instructions.md or built-in default
      - The rest of the prompt (project info, git history, project requirements) is constructed by ralph as normal
    passing: true

  - category: ralph-merge-command
    description: Ralph CLI merge command that submits an Argo workflow to clean up and merge a PR
    items:
      - Ralph has a merge subcommand that accepts a project file path and a PR branch name
      - The merge command generates and submits an Argo workflow (same mechanism as the run command)
      - The workflow container clones the repo, checks out the PR branch, checks whether all requirements in the project file are passing, removes the project file, commits the deletion, pushes, and merges the PR via gh CLI
      - If requirements are not all passing the workflow exits without making changes
      - The merge command does not wait for the workflow to complete
    passing: true

  - category: workflow-invocation
    description: Invoke ralph workflows in response to PR events
    items:
      - For comment events, service constructs a webhook-specific instructions file whose content replaces the default ralph instructions
      - The instructions file includes the triggering comment text and directs the agent to answer questions, write code if requested, commit and push changes, and post a GitHub PR comment summarising what was done
      - For comment events, service invokes ralph with the project file and --instructions, submitting a remote workflow
      - For approval events, service invokes ralph merge with the project file and PR branch name
      - The service does not wait for any workflow to complete
    passing: true

  - category: dev-environment
    description: Hot-reload development environment using Air
    items:
      - Service directory contains an Air config (.air.toml) for hot reload during development
      - Air watches Go source files and rebuilds on change
      - README or comments document how to run the service locally with Air
    passing: false

  - category: container
    description: Webhook service binary is included in the existing ralph container image
    items:
      - The existing ralph Containerfile is updated to also build and include the webhook service binary
      - The webhook service binary is available at a well-known path in the container (e.g. /usr/local/bin/github-webhook)
      - The container image can run either the ralph CLI or the webhook service depending on the entrypoint/command used
    passing: true

